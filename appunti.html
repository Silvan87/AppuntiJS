<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Appunti</title>
    <link href="data:image/x-icon;base64,AAABAAEAEBAAAAEACABoBQAAFgAAACgAAAAQAAAAIAAAAAEACAAAAAAAAAEAAAAAAAAAAAAAAAEAAAAAAAAAAAAAx8PEAEowLABPQ0EAGcLwAJTN1ACn0t4AW7PNAACd1QCw0NsAAKfaAACm3QCP5/cAluT3AFZOTABIOTUAAKHbAHRubQAeHB0AAKTbAD4wLgDV5ucAqsTdAAjC8gAAo94AxdnjANPl6gDn29wADqHbAIWcqgAAotkAp8jjAACl2QANnNkAjYV/AJ3G4QCw1dcACHPAAKLD4QAWe8IAncTfACQbGQAApdoA0M3MADowMABGPjoAOzAoAACc2wBLRT8Ae3d3ALTT3gAAo9gACHG/AMHAuABEMjMAGqbXAPLy8AAAod4Ajuj4AAvD8gCb4/UAnJybADUvLACdnJsASj47AIfH0QBLPjsAAKPZAJ/B4QC9vLwAvry8AC2m1wCf09gArqmoAACe1wCo4+0AAJ3aABwSFAA/TUwAnczLAI7CxwBBNjIART03AACi3QBRREQAqqmpAKXm9gCyra4AAKXdAC4pJgALdMEAAMPsAACd2wDU7/QAAG66AKSjogDd4OQArKenAACj2wAFxe8Aps7XAJTo8gAoIiIAm46LAAfE8gBtxN0AkIiEAAl3ugAApNkAAKfZAK+nqAAAptwACaTZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAXxEBGxsbODg4ODgAAAAAADFOQVBPFQAAAAAAAAAAAABgSAYFBycmAAAAAAAAAAAAADIkGTcIayMAAAAAAAAAAAAaaUczOVxeHwAAAAAAAAAAXQQKCyoQTDQWAAAAAAAAAABlaCBvEx5KWkQAAAAAAAAAAA1bWBMzQy8lKAAAAAAAAAAAOhdsE2JTIR01AAAAAAAAAABWOxhtHAkiTWEAAAAAAAAAAAxjcGRqWQISVQAAAAAAAAAAPEtnFFI2LilGAAAAAAAAAAArLTBAD1FmVwAAAAAAAAAAAEkOA0I+PwAAAAAAAAAAAAAAblQsPQAAAAAAAAAAAAAAAABFRQAAAAAfAAAD/wAAAf8AAID/AACAfwAAgD8AAMAfAADgDwAA8AcAAPgDAAD8AQAA/gAAAP8AAAD/gQAA/8MAAP/nAAA=" rel="icon" type="image/x-icon" />
    <script src="appunti.js"></script>
    <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    html {
        font-size: 16px;
    }
    body, input, textarea, code {
        background: #555;
        color:#cfcfcf;
        font-size: .95rem;
        line-height: 1.25rem;
        font-family: Verdana, sans-serif;
    }
    body {
        padding: .5rem;
    }
    input:focus, textarea:focus, button:focus, code:focus {
        outline: none;
    }
    a::before, a:visited::before {
        content: "üñù ";
    }
    a, a:visited {
        color: #ccf;
    }
    a:hover {
        color: #0ff;
    }
    ::selection {
        background: #9e9e0a;
        color: white;
    }
    ::-webkit-scrollbar {
        width: 0;
        height: 0;
    }
    #categoria {
        color: #cc0;
        font-weight: bold;
        cursor: pointer;
    }
    input, button {
        height: 2rem;
    }
    label, input, textarea, code {
        padding: .125rem;
    }
    textarea {
        resize: none;
    }
    #ricerca {
        display: flex;
        align-items: baseline;
        flex-wrap: wrap;
        min-height: 2.5rem;
    }
    #ricerca label {
        display: inline-block;
        margin-right: .5rem;
    }
    #ricerca input {
        flex: 1;
        margin-bottom: .5rem;
        border: none;
        border-bottom: 2px solid #cc0;
    }
    .comandi {
        margin-left: .25rem;
    }
    .comandi button {
        width: 2rem;
        border-radius: 1rem;
        background: #dfca14;
        border-width: 2px;
        border-style: solid;
        border-color: #e4e437 #9e9e0a #9e9e0a #e4e437;
        font-weight: bold;
        margin: 0 0 .5rem .25rem;
        background-repeat: no-repeat;
        background-origin: border-box;
        background-position: 5px 5px;
        background-size: 22px;
    }
    .comandi button:active {
        background-color: #9e9e0a;
        background-position: 6px 6px;
        border-color: #9e9e0a #e4e437 #e4e437 #9e9e0a;
    }
    /* Modified icons under CC0 1.0 Universal Public Domain Dedication from aiconica.net */
    .comandi .copiaAppunto {
        background-image: url(" data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAWEAQAAAA+LXjzAAAAdklEQVQ4y2NgIAr8/4+KSQbYNIPYL14gxN+9w5THayEuV4HYP38q7mNgAGEGht+/cRuM1XBckiD+nz8IPrrBIHD2LIkGo7sGn68Gh8EwwMiIHVNsMDmpCY8kLCXgwoMxjGkeeaNhPOTCeCgZTAmmn8HUMJwOAAB7Ick4UF8kVAAAAABJRU5ErkJggg==");
    }
    .comandi .salvaAppunto {
        background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAWAQMAAAD+ev54AAAABlBMVEUAAAAAAAClZ7nPAAAAAXRSTlMAQObYZgAAADpJREFUCB0FwTEVABAUAMDzDH8UQQUJ5DIYRBNFBKPRHQAAGgYe6ZIPsbWyjMrs9El9lEsc8iYtAPABxWoLR/tMQrQAAAAASUVORK5CYII=");
    }
    .comandi .salvaAppuntoModificato {
        background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAWEAQAAAA+LXjzAAAAJ0lEQVQ4y2NgGAWjYBTgBIwI5v//aFIUyTHRysVDz+BRMApGAR4AAFVDBggu+5KyAAAAAElFTkSuQmCC");
        background-color: coral;
        border-color: #f97 #c64 #c64 #f97;
    }
    .comandi .eliminaAppunto {
        background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAWEAQAAAA+LXjzAAAA8UlEQVQ4y7WVOw7DIAyGOUDXbpk7dKvUa2TuEXqB3qKHqppDhSVKKguZh1+ARJGsEPj9yYANzgnttASrNdRVtSCYHun//NG1+Rz4qHCYuDxtgDUGvgzOocehgTg0aa9vAs+XH4T77pz3jmg4FDSgTfC4LWX4CIUvWAnnUNSVcAFMHTS4rYlMeYm547qmOejrUJYhdfi2BeuA6nAanbaKSi7LcBolRt8B7QUjrEzXwVuhlv+Iw2OMkekWWX8rkDEljUbArZcQP/0cLpQ0dO5evzbzPLWuTXFrYWB+8QVLya+llvmK3L5tFUXhTe9e6yNp6X4/DTU0/L/qwAAAAABJRU5ErkJggg==");
    }
    .comandi .downloadAppunti {
        background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAWAQMAAAD+ev54AAAABlBMVEUAAAAAAAClZ7nPAAAAAXRSTlMAQObYZgAAADFJREFUCNdjYKhgYMCH2f83MDD/Z2Bg/Afk/4GIFRhYMHxgsAHj////wHH9/x8MUAAAFIoXUIkx3WQAAAAASUVORK5CYII=");
    }
    .comandi .inserisciTagHtml {
        background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAWEAQAAAA+LXjzAAAAZElEQVQ4y2NgGLZAcR8EUwn8/0+eHEFDYZgUOaINJWQw0Yaja+LkJM9yilxClHpMRbCUgAsTYThZYUZIP6WG4jScZgbjdjVxYUyzcCYzZVAxeRKrmCq5j4GayZMmhRBNi82RBgCaMe7hfeKokQAAAABJRU5ErkJggg==");
    }
    .comandi .inserisciTagMark {
        background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAWEAQAAAA+LXjzAAAAa0lEQVQ4y+XUSQoAIAgF0K7S/e/Q1WwREZXm9HcJLQR9NJdiDqIxoDFRKH6iEFxCU7iEpHCtOYRbm1w4X1zbXrXyEM5BXJ44yDccvhUSrK9M3e+7gd9XNwy8x5ZXl4alWUJgSw77fz+Cf4sOlrjkugZosPwAAAAASUVORK5CYII=");
    }
    .comandi .rimuoviTagHtml {
        background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAWEAQAAAA+LXjzAAAApElEQVQ4y63Uyw2AMAgAUGg8m3hwAFbp4KzSTcSDMVGD5dNyMlJfaCsAJIO4n8dRtFWYExcqAiBCbFceRqfhGjqM99A07kE1HC20VZHY7hCnVapVXqxKiRHNKjL/6f3OuwP1AjX0mbPwMOrB02gPH0aD8yLWOcT77vomMq2Ity1UiAcnXtcIin9N8V3Yy73XTW7j7+Uv4SHiDNTPvJQM1upx3M8nkNYnLkblGykAAAAASUVORK5CYII=");
    }
    .comandi .svuotaLocalStorage {
        background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAWEAQAAAA+LXjzAAAAVklEQVQ4y2NkwAv+/8cvz8iIU4Z8Q/EbzkKuRkIWM5LuQuIcwsRAH/D/P3kux9THRLxiQnxUQLOgGDV41OBRg/EAFuKLS0J8ogymvAhlpJ6h+H0w+AEASjQgGag62FcAAAAASUVORK5CYII=");
    }
    #risultati {
        display: flex;
        flex-wrap: wrap;
    }
    #elencoAppunti {
        flex: 1;
        margin: .5rem .5rem 0 0;
        padding: .5rem;
        min-width: 15rem;
        height: calc(100vh - 4.2rem);
        overflow: auto;
        scrollbar-width: none;
        background: #666;
    }
    #elencoAppunti label {
        display: block;
        color: #eee;
    }
    #elencoAppunti label.nuovoAppunto {
        color:#aaa;
    }
    #elencoAppunti label:hover {
        outline: 1px solid #cc0;
    }
    #elencoAppunti label.appuntoSelezionato {
        color: #cc0;
    }
    #appunto {
        flex: 3;
        width: 100%;
        min-width: 15rem;
        height: calc(100vh - 4.2rem);
        margin-top: .5rem;
        padding: .5rem;
        border: none;
        overflow: auto;
        scrollbar-width: none;
        font-family: "Courier New", Courier, monospace;
        line-height: 1.5rem;
        color: #aaa;
    }
    #appunto h1, #appunto h2, #appunto h3 {
        font-size: .95rem;
        line-height: 1.25rem;
        margin: 0 0 4px 0;
        padding: 0;
    }
    #appunto h1 {
        background-color: #373737;
        outline: 2px solid #373737;
        color: #dfdfdf;
    }
    #appunto h2 {
        background-color: #3f3f3f;
        outline: 2px solid #3f3f3f;
        color: #bfbfbf;
    }
    #appunto h3 {
        background-color: #474747;
        outline: 2px solid #474747;
        color: #9f9f9f;
    }
    #appunto mark {
        background: none;
        color: #d7d7d7;
    }
    #appunto u {
        text-decoration: none;
        border-bottom: 1px dashed #ccf;
        background-color: #556;
    }
    @media (max-width: 600px) {
        #risultati {
            flex-direction: column;
        }
        #elencoAppunti, #appunto {
            height: 100%;
        }
    }
    </style>
</head>

<body onload="eseguiRicercaPerParoleChiave()">
    <div id="ricerca">
        <label id="categoria" onclick="tornaACategoriaPiuGenerica()">*</label>
        <input type="text" id="parole-chiave" onkeypress="controllaComando(event)"
            value="">
        <div class="comandi">
            <button onclick="copiaAppunto()" title="Copia appunto"
                class="copiaAppunto" id="btnCopia">&nbsp;</button>
            <button onclick="salvaAppunto(CON_TITOLO)" title="Salva appunto nel browser"
                onmouseover="autoSalvataggio=false" onmouseout="autoSalvataggio=true"
                class="salvaAppunto" id="btnSalva">&nbsp;</button>
            <button onclick="eliminaAppunto()" title="Elimina appunto dal browser"
                onmouseover="autoSalvataggio=false" onmouseout="autoSalvataggio=true"
                class="eliminaAppunto" id="btnElimina">&nbsp;</button>
            <button onclick="downloadAppunti()" title="Download appunti su file"
                class="downloadAppunti" id="btnDownload">&nbsp;</button>
        </div>
    </div>
    <div id="risultati">
        <div id="elencoAppunti"></div>
        <code id="appunto" contenteditable="true"
            onkeydown="inserisciTabulazione(this, event);" oninput="segnalaAppuntoModificato(true)"
            onblur="if (appuntoModificato && autoSalvataggio) salvaAppunto();"></code>
    </div>

<script type="text/javascript">
// Costanti
const CON_TITOLO = true;
const CON_CATEGORIE = false;
const APPUNTI_TROVATI = true;

// Variabili generali
var categoriaCorrente = '*';
var paroleRicerca = [];
var ripetiRicercaSeVuota = true;
var appuntiTrovati = [];
var appuntoCorrente = {
    'indice': -1,
    'titolo': [],
    'categoria': '*',
    'indiceEtichetta': -1
}
var autoSalvataggio = true;
var appuntoModificato = false;
var ultimoTagInserito = '';

// Elementi usati con frequenza
var e_categoria = document.getElementById('categoria');
var e_parole_chiave = document.getElementById('parole-chiave');
var e_elenco_appunti = document.getElementById('elencoAppunti');
var e_appunto = document.getElementById('appunto');
var e_btn_copia = document.getElementById('btnCopia');
var e_btn_salva = document.getElementById('btnSalva');
var e_btn_elimina = document.getElementById('btnElimina');
var e_btn_download = document.getElementById('btnDownload');

function eseguiRicercaPerParoleChiave() {
    normalizzaInputParoleChiave();
    svuotaAppuntoCorrente();
    ripetiRicercaSeVuota = true;
    mostraAppuntiTrovati();
    selezionaParoleChiave();
    segnalaAppuntoModificato(false);
}

function tornaACategoriaPiuGenerica() {
    if (e_parole_chiave.value !== '') {
        e_parole_chiave.value = '';
    } else {
        if (e_categoria.innerHTML !== '*') {
            e_parole_chiave.value = '*';
        }
    }
    eseguiRicercaPerParoleChiave();
}

function normalizzaInputParoleChiave() {
    e_parole_chiave.value = e_parole_chiave.value.trim().toLowerCase().replace(/[\s]+/g, ' ');
    paroleRicerca = e_parole_chiave.value.split(' ').filter(function (e) { return e !== ''; });;
    separaCategoriaDaParoleChiave();
}

function ordinaAppuntiTrovati() {
    appuntiTrovati.sort((a, b) => {
        let differenzaPunteggio = b.punteggio - a.punteggio;
        if (differenzaPunteggio === 0) {
            return appunti[a.categoria][a.indice][0].length - appunti[b.categoria][b.indice][0].length;
        } else {
            return differenzaPunteggio;
        }
    });
}

function cercaAppuntiInCategoria(categoria) {
    for (let i = 0; i < appunti[categoria].length; i++) {
        let punteggio = 0;
        let almenoUnaParola = false;
        for (let j = 0; j < paroleRicerca.length; j++) {
            if (appunti[categoria][i][0].indexOf(paroleRicerca[j]) !== -1) {
                almenoUnaParola = true;
                punteggio += 1;
            } else {
                for (let k = 0; k < appunti[categoria][i][0].length; k++) {
                    if (appunti[categoria][i][0][k].startsWith(paroleRicerca[j])) {
                        almenoUnaParola = true;
                        punteggio += 0.1;
                    } else if (appunti[categoria][i][0][k].includes(paroleRicerca[j])) {
                        almenoUnaParola = true;
                        punteggio += 0.01;
                    }
                }
            }
        }
        if (almenoUnaParola) {
            appuntiTrovati.push({
                'indice': i,
                'punteggio': punteggio,
                'categoria': categoria
            });
        }
    }
}

function cercaAppuntiRilevanti() {
    // Svuota gli ultimi appunti trovati
    appuntiTrovati = [];
    // Controlla che le parole di ricerca siano valide
    if (paroleRicerca.length > 0 && paroleRicerca[0] !== '') {
        // Cerca in tutte le categorie
        if (categoriaCorrente === '*') {
            for (let categoria in appunti) {
                cercaAppuntiInCategoria(categoria);
            }
        // Cerca nella categoria corrente
        } else if (appunti[categoriaCorrente] !== undefined) {
            cercaAppuntiInCategoria(categoriaCorrente);
        }
        ordinaAppuntiTrovati();
    // Se non ci sono parole di ricerca, mostra gli appunti pi√π recenti
    // Tale elenco √® disponibile solo per una specifica categoria
    } else if (paroleRicerca.length === 0) {
        for (let i = appunti[categoriaCorrente].length - 1; i >= 0; i--) {
            appuntiTrovati.push({
                'indice': i,
                'punteggio': 0,
                'categoria': categoriaCorrente
            });
        }
        if (categoriaCorrente === '*') return CON_CATEGORIE;
    }
    return APPUNTI_TROVATI;
}

function cercaCategoria(categoria) {
    e_parole_chiave.value = categoria;
    eseguiRicercaPerParoleChiave(); // Ricerca categoria
    eseguiRicercaPerParoleChiave(); // Ricerca vuota nella categoria
}

function titoloAppuntoInElenco() {
    for (let i = 0; i < e_elenco_appunti.childElementCount; i++) {
        if (e_parole_chiave.value === e_elenco_appunti.childNodes[i].dataset.paroleRicerca) {
            return true; // titolo trovato
        }
    }
    return false; // titolo non trovato
}

function selezionaEtichetta(i) {
    // Deseleziona tutte le etichette
    for (let j = 0; j < e_elenco_appunti.childElementCount; j++) {
        e_elenco_appunti.childNodes[j].classList.remove('appuntoSelezionato');
    }
    // Non prosegue se l'indice etichetta non √® noto
    if (i === -1) return;
    // Seleziona etichetta corrente
    e_elenco_appunti.childNodes[i].classList.add('appuntoSelezionato');
    appuntoCorrente.indiceEtichetta = i;
}

function preparaInserimentoNuovoAppunto() {
    if (e_parole_chiave.value !== '' &&
        (!e_elenco_appunti.firstChild || !titoloAppuntoInElenco())) {

        let e_label = document.createElement('label');
        e_label.onclick = function() { mostraAppunto(e_label, -1); };
        e_label.innerHTML = '(nuovo) ' + e_parole_chiave.value;
        e_label.classList.add('nuovoAppunto');
        e_elenco_appunti.insertBefore(e_label, e_elenco_appunti.firstChild);
    }
}

function svuotaElencoEtichette() {
    while (e_elenco_appunti.firstChild) {
        e_elenco_appunti.removeChild(e_elenco_appunti.firstChild);
    }
}

function mostraElencoCategorie() {
    var categorie = [];
    for (let categoria in appunti) {
        categorie.push(categoria);
    }
    categorie.sort();
    for (let i in categorie) {
        if (categorie[i] === '*') continue;
        let e_label = document.createElement('label');
        e_label.innerHTML = categorie[i];
        e_label.onclick = function() { cercaCategoria(categorie[i]) };
        e_elenco_appunti.appendChild(e_label);
    }
}

function mostraAppuntiTrovati() {
    svuotaElencoEtichette()

    if (cercaAppuntiRilevanti() === CON_CATEGORIE)
        mostraElencoCategorie();

    // Mostra elenco di etichette per ogni appunto trovato
    for (let i = 0; i < appuntiTrovati.length; i++) {
        let categoriaAppunto = appuntiTrovati[i].categoria;
        let e_label = document.createElement('label');
        e_label.onclick = function() { mostraAppunto(e_label, i); };
        e_label.dataset.paroleRicerca = appunti[categoriaAppunto][appuntiTrovati[i].indice][0].join(' ');
        if (categoriaCorrente === '*') {
            e_label.innerHTML = categoriaAppunto +' '+ e_label.dataset.paroleRicerca;
        } else {
            e_label.innerHTML = e_label.dataset.paroleRicerca;
        }
        e_elenco_appunti.appendChild(e_label);
    }
    preparaInserimentoNuovoAppunto();
    if (ripetiRicercaSeVuota && !e_elenco_appunti.firstChild) {
        ripetiRicercaSeVuota = false;
        normalizzaInputParoleChiave();
        mostraAppuntiTrovati();
    }
    selezionaEtichetta(appuntoCorrente.indiceEtichetta);
}

function mostraAppunto(e_etichetta, i) {
    // L'indice non esiste, prepara nuovo appunto
    if (i === -1) {
        svuotaAppuntoCorrente()
        appuntoCorrente.titolo = paroleRicerca;
        e_appunto.focus();

    // L'indice esiste, mostra l'appunto trovato
    } else {
        // i: indice appunto trovato
        // j: indice appunto nella categoria
        let j = appuntiTrovati[i].indice;
        let categoriaAppunto = appuntiTrovati[i].categoria;
        e_appunto.innerHTML = appunti[categoriaAppunto][j][1]; // 1: testo appunto
        // Aggiorna appunto corrente
        appuntoCorrente.indice = j;
        appuntoCorrente.titolo = appunti[categoriaAppunto][j][0]; // 0: titolo appunto
        appuntoCorrente.categoria = categoriaAppunto;
    }
    segnalaAppuntoModificato(false);
    appuntoCorrente.indiceEtichetta = Array.from(e_etichetta.parentNode.children).indexOf(e_etichetta);
    selezionaEtichetta(appuntoCorrente.indiceEtichetta);
}

function separaCategoriaDaParoleChiave() {
    // Se la prima parola chiave √® una parola categoria, la recupera e la separa
    if (paroleRicerca[0] !== '' &&
        categorie[paroleRicerca[0]] !== undefined &&
        categorie[paroleRicerca[0]] !== categoriaCorrente) {

        e_categoria.innerHTML = categorie[paroleRicerca[0]];
        categoriaCorrente = categorie[paroleRicerca[0]];

        if (paroleRicerca.length > 1) {
            paroleRicerca.splice(0, 1);
            e_parole_chiave.value = paroleRicerca.join(' ');
        } else {
            e_parole_chiave.value = '';
        }
    }
}

function selezionaParoleChiave() {
    e_parole_chiave.selectionStart = 0;
    e_parole_chiave.selectionEnd = e_parole_chiave.value.length;
    e_parole_chiave.focus();
}

function copiaAppunto() {
    let testoAppunto = e_appunto.innerHTML;
    if (testoAppunto.trim() !== '') {
        // Converte caratteri codificati nel relativo carattere
        testoAppunto = testoAppunto
            .replace(/<br>/g, '\n')
            .replace(/(<([^>]+)>)/ig, '')
            .replace(/&amp;/g, '&');
        // TODO Dopo aver specificato quali sono i #commenti, si potrebbe copiare solo il codice d'esempio
        // Copia testo negli appunti di sistema
        navigator.clipboard.writeText(testoAppunto);
        // Seleziona ci√≤ che √® stato copiato
        e_appunto.focus();
        document.execCommand('selectAll');
    }
}

function circondaSelezioneConTag(tag) {
    let msgAnnulla = '';
    let sel = window.getSelection();
    let range = sel.getRangeAt(0);
    let selTxt = sel.toString()
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;').replace(/>/g, '&gt;')
        .replace(/\n/g, '<br>').replace(/ /g, '&nbsp;')
        .replace(/&nbsp;(?!&nbsp;)/g, ' ')
        .replace(/&nbsp; /g, '&nbsp;&nbsp;');
    // Annulla se la selezione √® vuota
    if (sel.isCollapsed || selTxt.trim() === '') {
        msgAnnulla = 'La selezione √® vuota.';
    }
    // Chiedi il tag all'utente se non √® stato preinserito
    let tagPreinserito = false;
    if (tag !== 'mark') {
        tag = prompt('Specifica il tag html che circonder√† la selezione:', ultimoTagInserito);
        if (tag === null) {
            msgAnnulla = 'Inserimento annullato dall\'utente';
        } else {
            tag = tag.trim();
        }
    } else {
        tagPreinserito = true;
    }
    // Annulla se il tag √® vuoto
    if (tag === '') {
        msgAnnulla = 'Tag non valido.';
    }
    // Verifica annullamento tag
    if (msgAnnulla !== '') {
        alert('Inserimento tag annullato.\n\n' + msgAnnulla);
        mostraComandiOrdinari();
        return;
    }
    e_appunto.focus();
    let e_new = document.createElement(tag);
    if (tag !== 'mark') ultimoTagInserito = tag;
    e_new.innerHTML = selTxt;
    // Gestione speciale di alcuni tag
    switch (tag) {
        case 'a':
            let link = prompt('Specifica l\'URL del link:', selTxt);
            link = (link === null) ? '' : link.trim();
            if (!link.startsWith('http://') && !link.startsWith('https://')) link = 'http://' + link;
            e_new.setAttribute('href', link);
            e_new.setAttribute('target', '_blank');
            break;
    }
    range.deleteContents();
    range.insertNode(e_new);
    if (!tagPreinserito) mostraComandiOrdinari();
    segnalaAppuntoModificato(true);
}

function rimuoviTagDaSelezione() {
    let modifica = false;
    e_appunto.focus();
    let sel = window.getSelection();
    let selTxt = sel.toString()
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;').replace(/>/g, '&gt;')
        .replace(/\n/g, '<br>').replace(/ /g, '&nbsp;');
    if (sel.isCollapsed === true || selTxt === '') {
        if (confirm("Nessuna selezione effettuata. Ripulire l'appunto da tutti i tag?")) {
            modifica = true;
            selTxt = e_appunto.innerHTML
                .replace(/<br>/g, '\n')
                .replace(/(<([^>]+)>)/ig, '')
                .replace(/\n/g, '<br>');
            e_appunto.innerHTML = '';
        }
    } else {
        modifica = true;
        let range = sel.getRangeAt(0);
        range.deleteContents();
    }
    if (modifica) {
        document.execCommand('insertHTML', false, selTxt);
        mostraComandiOrdinari();
        segnalaAppuntoModificato(true);
    }
}

function aggiungiCategoriaCorrente() {
    if (appunti[categoriaCorrente] === undefined) {
        appunti[categoriaCorrente] = [];
        if (categorie[categoriaCorrente.toLowerCase()] === undefined) {
            // TODO Qui sarebbe l'ideale poter definire la nuova categoria ed inserirla
            // Es.: Prova prova prv (tramite prompt)
            // TODO Come ridefinire le categorie gi√† esistenti? Quando?
            alert("Attenzione. La categoria che √® stata creata non era prevista nell'array associativo Categorie. " +
                "La categoria verr√† creata correttamente, per√≤ affinch√© si possa effettivamente utilizzarla, " +
                "occorre modificare manualmente il file 'appunti.js' ed aggiungere la nuova categoria all'array " +
                "categorie.");
        }
    }
}

function aggiornaLocalStorage() {
    // Controlla che il browser supporti localStorage
    if (typeof(Storage) !== undefined) {
        try {
            localStorage.setItem("appunti_categorie", JSON.stringify(categorie));
            localStorage.setItem("appunti_dati", JSON.stringify(appunti));
        } catch (e) {
            // Chrome o Chromium possono avere i permessi di scrittura nel localStorage disabilitati
            // Firefox ed Opera dovrebbero funzionare in via predefinita
            alert("Impossibile salvare gli appunti in modo permanente. Il browser nega l'accesso al localStorage " +
                "da parte dei file locali. Se state usando Chrome o Chromium la soluzione √® probabilmente questa: " +
                "spostarsi in alto a destra e cliccare sul menu generale con l'icona ·çß ; cliccare su Impostazioni " +
                "(Settings); scorrere le sezioni fino in fondo e cliccare su Avanzate (Advanced); nella sezione " +
                "Privacy e sicurezza (Privacy and Security), cliccare su Impostazioni contenuti (Content Settings); " +
                "poi cliccare sulla prima voce Cookie; \"Blocca cookie di terze parti\" probabilmente √® attivo, ma " +
                "pu√≤ rimanere cos√¨; aggiungere un'eccezione per i file locali cliccando su Aggiungi (Add) alla voce " +
                "Consenti (Allow); inserire nella casella di testo quanto segue: file:///* e cliccare sul pulsante " +
                "Aggiungi (Add). D\'ora in avanti Chrome o Chromium permetteranno ai file html sul vostro PC di " +
                "salvare qualche dato nell\'HTML5 storage. Ricaricate questa pagina html ed i salvataggi dovrebbero " +
                "funzionare.");
        }
    } else {
        // localStorage non supportato dal browser
        alert("Impossibile salvare gli appunti in modo permanente.\nIl browser non supporta il localStorage." +
            "\nDotarsi di un browser aggiornato.");
        autoSalvataggio = false;
    }
}

function svuotaAppuntoCorrente() {
    e_appunto.innerHTML = '';
    appuntoCorrente.categoria = categoriaCorrente;
    appuntoCorrente.titolo = paroleRicerca;
    appuntoCorrente.indice = -1;
    appuntoCorrente.indiceEtichetta = -1;
}

function salvaAppunto(conTitolo) {
    if (e_appunto.innerHTML.trim() !== '' && appuntoCorrente.titolo.length > 0) {
        let appuntoValido = true;
        let appuntoCategoriaPrecedente = appuntoCorrente.categoria;
        if (conTitolo) {
            let titoloConCategoria =
                prompt("Specificare categoria e titolo dell'appunto:\n\n" +
                "Es. Categoria parola1 parola2 parolaN\n\n",
                appuntoCorrente.categoria +' '+ appuntoCorrente.titolo.join(' '));

            if (titoloConCategoria !== null && titoloConCategoria.trim() !== '') {
                titoloConCategoria = titoloConCategoria.trim().split(' ');
                if (titoloConCategoria.length >= 2) {
                    let categoriaPrecedente = categoriaCorrente;
                    categoriaCorrente = titoloConCategoria[0];
                    appuntoCorrente.categoria = categoriaCorrente;
                    aggiungiCategoriaCorrente();
                    categoriaCorrente = categoriaPrecedente;
                    // Tutte le parole chiave devono essere salvate in minuscolo
                    appuntoCorrente.titolo = titoloConCategoria.slice(1).join(' ').toLowerCase().split(' ');
                } else {
                    appuntoValido = false;
                }
            } else {
                appuntoValido = false;
            }
        }
        if (appuntoValido) {
            // Se l'indice non esiste, aggiungi nuovo appunto
            if (appuntoCorrente.indice === -1) {
                aggiungiCategoriaCorrente();
                appunti[appuntoCorrente.categoria].push([appuntoCorrente.titolo, e_appunto.innerHTML]);
                appuntoCorrente.indice = appunti[appuntoCorrente.categoria].length - 1;

            // Se l'indice esiste, sovrascrivi l'appunto corrente
            } else {
                // Se l'appunto modificato ha sempre la stessa categoria, viene semplicemente sovrascritto
                if (appuntoCorrente.categoria === appuntoCategoriaPrecedente) {
                    appunti[appuntoCorrente.categoria][appuntoCorrente.indice] =
                        [appuntoCorrente.titolo, e_appunto.innerHTML];

                // Se la categoria √® cambiata, elimina il vecchio appunto
                // e aggiunge quello corrente alla nuova categoria
                } else {
                    appunti[appuntoCategoriaPrecedente].splice(appuntoCorrente.indice, 1);
                    appunti[appuntoCorrente.categoria].push([appuntoCorrente.titolo, e_appunto.innerHTML]);
                    appuntoCorrente.indice = appunti[appuntoCorrente.categoria].length - 1;
                }

            }
            // Il salvataggio automatico non deve svuotare il testo dell'appunto
            if (!autoSalvataggio) {
                svuotaAppuntoCorrente();
                appuntoCorrente.indiceEtichetta = -1;
            }
            mostraAppuntiTrovati();
            aggiornaLocalStorage();
            segnalaAppuntoModificato(false);
        } else {
            alert("Il salvataggio dell'appunto √® stato annullato.");
        }
    } else if(conTitolo) {
        alert("Non √® possibile salvare un appunto senza parole chiave o senza contenuto.");
    }
}

function eliminaAppunto() {
    if (confirm('Eliminare l\'appunto corrente?')) {
        e_appunto.innerHTML = '';
        segnalaAppuntoModificato(false);
        if (appuntoCorrente.indice !== -1) {
            appunti[appuntoCorrente.categoria].splice(appuntoCorrente.indice, 1);
            appuntoCorrente.titolo = [];
            appuntoCorrente.indice = -1;
            appuntoCorrente.indiceEtichetta = -1;
            mostraAppuntiTrovati();
            aggiornaLocalStorage();
        }
    }
}

function downloadAppunti() {
    var a = document.createElement('a');
    let str = 'var categorie, appunti;\n' +
        'function caricaDaAppuntiJS() {\n' +
        'categorie = ' + JSON.stringify(categorie) + '\n' +
        'appunti = ' + JSON.stringify(appunti) + '\n' +
        '}';
    a.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(str));
    a.setAttribute('download', 'appunti.js');
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

function caricaDaLocalStorage() {
    // Controlla che il browser supporti localStorage
    if (typeof(Storage) !== undefined) {
        try {
            categorie = JSON.parse(localStorage.getItem('appunti_categorie'));
            appunti = JSON.parse(localStorage.getItem('appunti_dati'));
        } catch (e) {
            return false;
        }
        if (categorie !== null && appunti !== null &&
            categorie !== undefined && appunti !== undefined) {
            // Caricamento da localStorage avvenuto con successo
            return true;
        }
    }
    // Caricamento da localStorage fallito
    return false;
}

function svuotaLocalStorageECaricaFile() {
    if (confirm('Desideri svuotare la memoria locale del browser e ricaricare gli appunti dal file appunti.js?\n\n' +
        'Se ci sono appunti non scaricati su un file, questi verranno persi. Procedere?')) {

        localStorage.removeItem('appunti_categorie');
        localStorage.removeItem('appunti_dati');
        location.reload();

    } else {
        alert("Operazione annullata. La memoria locale sul browser √® stata conservata.");
    }
    mostraComandiOrdinari();
}

function controllaComando(event) {
    // Invio: inizia la ricerca
    if (event.keyCode === 13) {
        event.preventDefault();
        appuntoCorrente.indiceEtichetta = -1;
        eseguiRicercaPerParoleChiave();
    }
}

function segnalaAppuntoModificato(statoModifica) {
    if (statoModifica === true) {
        appuntoModificato = true;
        e_btn_salva.className = 'salvaAppuntoModificato';
    } else {
        appuntoModificato = false;
        e_btn_salva.className = 'salvaAppunto';
    }
}

function mostraComandiAlternativi1() {
    e_btn_copia.className = 'inserisciTagHtml';
    e_btn_copia.title = 'Inserisci un tag html';
    e_btn_copia.onclick = circondaSelezioneConTag;

    e_btn_elimina.className = 'rimuoviTagHtml';
    e_btn_elimina.title = 'Rimuovi tag html dalla selezione';
    e_btn_elimina.onclick = rimuoviTagDaSelezione;

    e_btn_download.className = 'svuotaLocalStorage';
    e_btn_download.title = 'Svuota memoria appunti del browser';
    e_btn_download.onclick = svuotaLocalStorageECaricaFile;
}

function mostraComandiAlternativi2() {
    e_btn_copia.className = 'inserisciTagMark';
    e_btn_copia.title = 'Inserisci il tag mark';
    e_btn_copia.onclick = function() { circondaSelezioneConTag('mark') };
}

function mostraComandiOrdinari() {
    e_btn_copia.className = 'copiaAppunto';
    e_btn_copia.title = 'Copia appunto';
    e_btn_copia.onclick = copiaAppunto;

    e_btn_elimina.className = 'eliminaAppunto';
    e_btn_elimina.title = 'Elimina appunto dal browser';
    e_btn_elimina.onclick = eliminaAppunto;

    e_btn_download.className = 'downloadAppunti';
    e_btn_download.title = 'Download appunti su file';
    e_btn_download.onclick = downloadAppunti;
}

function inserisciTabulazione(txt, event) {
    if (event.keyCode === 9) {
        event.preventDefault();
        let selection = document.getSelection();
        let range = selection.getRangeAt(0);
        let tabNode = document.createTextNode('\u00a0\u00a0\u00a0\u00a0');
        range.insertNode(tabNode);
        range.setStartAfter(tabNode);
        range.setEndAfter(tabNode);
        selection.removeAllRanges();
        selection.addRange(range);
        appuntoModificato = true;
    }
}

e_appunto.addEventListener('paste', function(event) {
    // Annulla l'evento incolla
    event.preventDefault();
    // Recupera solo testo semplice dagli appunti di sistema
    let text = (event.originalEvent || event).clipboardData.getData('text/plain');
    // Codifica entit√† html e conserva i ritorni a capo
    text = text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/\n/g, '<br>')
        .replace(/ /g, '&nbsp;')
        .replace(/\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;')
        .replace(/&nbsp;(?!&nbsp;)/g, ' ')
        .replace(/&nbsp; /g, '&nbsp;&nbsp;');
    // Inserisce il testo come se fosse scritto manualmente
    document.execCommand('insertHTML', false, text);
});

document.addEventListener('keydown', function(event) {
    // Se Shift resta premuto, i comandi cambiano funzione
    if (event.keyCode === 16) mostraComandiAlternativi1();
    if ((event.shiftKey && event.keyCode === 17) ||
        (event.ctrlKey && event.keyCode === 16))
        mostraComandiAlternativi2();
});

document.addEventListener('keyup', function(event) {
    // Se Shift viene rilasciato, i comandi tornano ordinari
    if (event.keyCode === 16) mostraComandiOrdinari();
    if (event.shiftKey && event.keyCode === 17) mostraComandiAlternativi1();
});

if (!caricaDaLocalStorage()) {
    caricaDaAppuntiJS();
}
</script>
</body>

</html>